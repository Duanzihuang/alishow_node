{{extend './layout.html'}}

{{block 'head'}}
{{/block}}

{{block 'content'}}
<div class="container-fluid">
  <div class="page-title">
    <h1>分类目录</h1>
  </div>
  <!-- 有错误信息时展示 -->
  <!-- <div class="alert alert-danger">
    <strong>错误！</strong>发生XXX错误
  </div> -->
  <div class="row">
    <div class="col-md-4">
      <form>
        <h2>添加新分类目录</h2>
        <div class="form-group">
          <label for="name">名称</label>
          <input id="name" class="form-control" name="name" type="text" placeholder="分类名称">
        </div>
        <div class="form-group">
          <label for="slug">别名</label>
          <input id="slug" class="form-control" name="slug" type="text" placeholder="slug">
          <p class="help-block">https://example.com/category/<strong>slug</strong></p>
        </div>
        <div class="form-group">
          <button class="btn btn-primary" type="submit">添加</button>
        </div>
      </form>
    </div>
    <div class="col-md-8">
      <div class="page-action">
        <!-- show when multiple checked -->
        <a class="btn btn-danger btn-sm" href="javascript:;" style="display: none">批量删除</a>
      </div>
      <table class="table table-striped table-bordered table-hover">
        <thead>
          <tr>
            <th class="text-center" width="40"><input type="checkbox"></th>
            <th>名称</th>
            <th>Slug</th>
            <th class="text-center" width="100">操作</th>
          </tr>
        </thead>
        <tbody id="list_container"></tbody>
      </table>
    </div>
  </div>
</div>
{{/block}}

{{block 'script'}}
<script src="/public/assets/vendors/art-template/template-web.js"></script>
<script type="text/html" id="list_template">
  {%each listData%}
  <tr>
    <td class="text-center"><input type="checkbox"></td>
    <td>{% $value.cate_name %}</td>
    <td>{% $value.cate_slug %}</td>
    <td class="text-center">
      <a href="javascript:;" class="btn btn-info btn-xs">编辑</a>
      <a data-id="{% $value.cate_id %}" name="delete" href="javascript:;" class="btn btn-danger btn-xs">删除</a>
    </td>
  </tr>
  {%/each%}
</script>
<script>
  // 我们希望这里的模板字符串在 “浏览器” 中进行解析替换
  // 到浏览器后我们发现这里的 {{}} 没了
  // 原因是服务端的模板引擎给解析了
  // 1. 当前页面是服务端模板引擎渲染出来的
  // 2. 模板引擎是不关心你的内容的
  //    他不管你的 html、还是 JavaScript、css 等格式的字符串
  //    模板引擎只认识 {{}}
  //    你的 script、html、css 等，在服务端眼里都是：字符串
  // 这就是所谓的前后端模板语法冲突，前后端模板语法都一样，服务端也分不清哪些字符串是你浏览器模板引擎处理的
  // 解决办法就是：修改模板渲染语法
  // 标准语法的界定符规则
  // 修改界定符参考文档：https://aui.github.io/art-template/zh-cn/docs/rules.html
  template.defaults.rules[1].test = /{%([@#]?)[ \t]*(\/?)([\w\W]*?)[ \t]*%}/
  // var fn = template.compile('hello {%message%}')
  // var ret = fn({message: 'world'})
  // console.log(ret)
</script>
<script>

  // 异步加载数据列表
  loadList()

  // 动态渲染的DOM节点，要通过事件委托（事件代理）的方式注册事件
  $('#list_container').on('click', 'a[name=delete]', handleDelete)

  function handleDelete() {
    if (!window.confirm('Are you sure?')) {
      return
    }
    var id = $(this).data('id')
    $.ajax({
      url: '/api/categories/delete',
      method: 'GET',
      data: {
        id: id
      },
      dataType: 'json',
      success: function (resData) {
        // 如果删除成功，重新加载列表数据
        if (resData.success) {
          loadList()
        }
      },
      error: function (error) {
        console.log(error)
      }
    })
    return false
  }

  function loadList() {
    $.ajax({
      url: '/api/categories',
      method: 'GET',
      data: {},
      dataType: 'json',
      success: function (resData) {
        // 1. 得到请求响应数据
        if (resData.success) {
          // 2. 使用模板引擎解析替换模板字符串
          var htmlStr = template('list_template', {
            listData: resData.data
          })
          // 3. 把解析替换的结果放到列表容器中
          $('#list_container').html(htmlStr)
        }
      },
      error: function (error) {
        console.log(error)
      }
    })
  }
</script>
{{/block}}
